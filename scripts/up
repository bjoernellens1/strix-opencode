#!/usr/bin/env bash
set -euo pipefail

# Resolve repo root (where .env and models/ live)
REPO_ROOT="$(cd "$(dirname "$0")/.." && pwd)"

cp -n "$REPO_ROOT/.env.example" "$REPO_ROOT/.env" 2>/dev/null || true

MODE="${1:-gpu}"

# --project-directory ensures relative paths in .env (e.g., ./models)
# resolve from the repo root, not from the compose file's directory.
COMPOSE="docker compose --project-directory $REPO_ROOT --env-file $REPO_ROOT/.env"

case "$MODE" in
  gpu)
    $COMPOSE -f compose/vllm.yml up -d
    ;;
  gpu-all)
    # GPU-only mode (Phase 4) with vLLM BF16 for all agents.
    # Starts Thor (always-on) + Valkyrie (standard profile) + Bifrost daemon.
    $COMPOSE -f compose/gpu-all.yml --profile standard --profile bifrost up -d
    ;;
  gpu-all-no-bifrost)
    # GPU-only mode without Bifrost. Thor + Valkyrie only.
    $COMPOSE -f compose/gpu-all.yml --profile standard up -d
    ;;
  hybrid)
    # Hybrid mode (Phase 5) â€” llama.cpp GGUF for Thor/Valkyrie/Odin, vLLM BF16 for utility.
    # Starts Thor + Valkyrie + Bifrost. Other agents summoned on-demand.
    $COMPOSE -f compose/hybrid.yml --profile standard --profile bifrost up -d
    ;;
  hybrid-no-bifrost)
    # Hybrid mode without Bifrost. Thor + Valkyrie only.
    $COMPOSE -f compose/hybrid.yml --profile standard up -d
    ;;
  cpu)
    $COMPOSE -f compose/cpu.yml up -d
    ;;
  full)
    $COMPOSE -f compose/vllm.yml -f compose/cpu.yml up -d
    ;;
  hybrid-radv)
    $COMPOSE -f compose/vllm.yml -f compose/fallback.vulkan-radv.orch.yml up -d
    ;;
  hybrid-rocm)
    $COMPOSE -f compose/vllm.yml -f compose/fallback.rocm-6.4.4-rocwmma.orch.yml up -d
    ;;
  *)
    echo "Usage: $0 {gpu|gpu-all|gpu-all-no-bifrost|hybrid|hybrid-no-bifrost|cpu|full|hybrid-radv|hybrid-rocm}"
    exit 1
    ;;
esac
