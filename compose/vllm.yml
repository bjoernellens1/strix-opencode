# Thor âš¡ (GPU): Primary Commander / Orchestrator â€” Qwen2.5-14B-Instruct BF16
# Valkyrie ðŸ›¡ (GPU): Execution Specialist / Coder â€” Qwen3-Coder-30B-A3B-Instruct BF16
#
# Staggered startup: Thor loads first (smaller, faster), then Valkyrie.
# On shared-memory GPUs (Strix Halo), concurrent vLLM startup causes the
# memory profiler to see the other instance's allocation, leading to
# negative KV cache budget and crash.
#
# Total GPU utilization: 0.35 + 0.60 = 0.95 (~6.4 GB headroom for system)
# All BF16 â€” no quantization or FP8 KV works on gfx1151 (RDNA 3.5).

services:
  vllm_thor:
    image: docker.io/kyuz0/vllm-therock-gfx1151:latest
    container_name: vllm_thor
    network_mode: host
    devices: ["/dev/kfd", "/dev/dri"]
    security_opt: ["seccomp=unconfined"]
    group_add: ["video", "render"]
    environment:
      - HF_HOME=${HF_HOME}
      - HF_TOKEN=${HF_TOKEN}
    volumes:
      - ${HF_HOME}:${HF_HOME}
      - ${VLLM_CACHE}:${VLLM_CACHE}
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://127.0.0.1:${THOR_PORT}/v1/models || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 60
      start_period: 120s
    command: >
      vllm serve ${THOR_MODEL}
      --host 0.0.0.0 --port ${THOR_PORT}
      --dtype auto
      --gpu-memory-utilization ${THOR_GPU_UTIL}
      --max-model-len ${THOR_MAX_LEN}
      --kv-cache-dtype ${THOR_KV_CACHE_DTYPE:-auto}
      --max-num-seqs ${THOR_MAX_NUM_SEQS:-256}
      --enable-prefix-caching

  vllm_valkyrie:
    image: docker.io/kyuz0/vllm-therock-gfx1151:latest
    container_name: vllm_valkyrie
    network_mode: host
    devices: ["/dev/kfd", "/dev/dri"]
    security_opt: ["seccomp=unconfined"]
    group_add: ["video", "render"]
    environment:
      - HF_HOME=${HF_HOME}
      - HF_TOKEN=${HF_TOKEN}
    volumes:
      - ${HF_HOME}:${HF_HOME}
      - ${VLLM_CACHE}:${VLLM_CACHE}
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://127.0.0.1:${VALKYRIE_PORT}/v1/models || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 60
      start_period: 120s
    depends_on:
      vllm_thor:
        condition: service_healthy
    command: >
      vllm serve ${VALKYRIE_MODEL}
      --host 0.0.0.0 --port ${VALKYRIE_PORT}
      --dtype auto
      --gpu-memory-utilization ${VALKYRIE_GPU_UTIL}
      --max-model-len ${VALKYRIE_MAX_LEN}
      --kv-cache-dtype ${VALKYRIE_KV_CACHE_DTYPE:-auto}
      --max-num-seqs ${VALKYRIE_MAX_NUM_SEQS:-256}
      --enable-prefix-caching
